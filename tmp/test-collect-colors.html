<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test collectFigmaColors()</title>
    <style>
      body {
        max-width: 80rem;
        margin: 0 auto;
        padding: 2rem;
        font-family: system-ui, sans-serif;
      }

      pre {
        padding: 1rem;
        overflow-x: auto;
        border-radius: 0.5rem;
        background: #f5f5f5;
      }

      .section {
        margin-bottom: 2rem;
        padding-left: 1rem;
        border-left: 4px solid #0066cc;
      }

      .comment {
        color: #008800;
        font-weight: 700;
      }

      .test-case {
        margin-bottom: 2rem;
        padding: 1.5rem;
        border-radius: 0.5rem;
        background: #fff8dc;
      }
    </style>
  </head>
  <body>
    <h1>Test collectFigmaColors()</h1>

    <div class="test-case">
      <h2>Test 1 : Sans import Figma (Raspberry uniquement)</h2>
      <div id="test1"></div>
    </div>

    <div class="test-case">
      <h2>Test 2 : Avec couleurs custom</h2>
      <div id="test2"></div>
    </div>

    <div class="test-case">
      <h2>Test 3 : Avec couleurs custom + extrapolation</h2>
      <div id="test3"></div>
    </div>

    <div class="test-case">
      <h2>Test 4 : Avec import Figma (pas de Raspberry)</h2>
      <div id="test4"></div>
    </div>

    <div class="test-case">
      <h2>Test 5 : Import Figma + custom + extrapolation</h2>
      <div id="test5"></div>
    </div>

    <script type="module">
      // Import des fonctions à tester
      import { loadAllCanonicals } from "../assets/js/modules/canonical-loader.js";

      // Copie des fonctions de génération
      function formatNumber(n) {
        const s = Number(n).toFixed(4);
        return s.replace(/(\.\d*?)0+$/, "$1").replace(/\.$/, "");
      }

      function generateRaspberryColors() {
        return `  --color-raspberry-100: oklch(0.95 0.05 10);
  --color-raspberry-200: oklch(0.85 0.1 10);
  --color-raspberry-300: oklch(0.75 0.15 10);
  --color-raspberry-400: oklch(0.65 0.18 10);
  --color-raspberry-500: oklch(0.55 0.2 10);
  --color-raspberry-600: oklch(0.45 0.18 10);
  --color-raspberry-700: oklch(0.35 0.15 10);`;
      }

      function parseCustomColors(customVarsText) {
        if (!customVarsText || !customVarsText.trim()) {
          return "";
        }

        const lines = customVarsText
          .split("\n")
          .map((line) => line.trim())
          .filter((line) => line.length > 0 && line.startsWith("--"));

        return lines.map((line) => `  ${line}`).join("\n");
      }

      function extrapolateCustomColors(customVarsText) {
        if (!customVarsText || !customVarsText.trim()) {
          return "";
        }

        const colorVarRegex = /--(color-[a-z0-9-]+):\s*oklch\(([^)]+)\)/gi;
        const matches = [...customVarsText.matchAll(colorVarRegex)];

        if (matches.length === 0) {
          return "";
        }

        const extrapolated = [];

        matches.forEach((match) => {
          const varName = match[1];
          const oklchValues = match[2];

          if (/-\d{3}$/.test(varName)) {
            return;
          }

          const [l, c, h] = oklchValues.split(/\s+/).map(Number);

          if (isNaN(l) || isNaN(c) || isNaN(h)) {
            return;
          }

          const shades = [
            { suffix: "100", lightness: Math.min(0.95, l + 0.3) },
            { suffix: "300", lightness: Math.min(0.9, l + 0.15) },
            { suffix: "500", lightness: l },
            { suffix: "700", lightness: Math.max(0.2, l - 0.15) },
            { suffix: "900", lightness: Math.max(0.1, l - 0.3) },
          ];

          shades.forEach(({ suffix, lightness }) => {
            const shadeName = `--${varName}-${suffix}`;
            const shadeValue = `oklch(${formatNumber(lightness)} ${c} ${h})`;
            extrapolated.push(`  ${shadeName}: ${shadeValue};`);
          });
        });

        return extrapolated.join("\n");
      }

      function collectFigmaColors({
        hasFigmaImport = false,
        customColors = "",
        shouldExtrapolate = false,
        figmaColors = [],
      } = {}) {
        const sections = [];

        if (!hasFigmaImport) {
          sections.push({
            comment: "/* Couleur projet placeholder : raspberry */",
            content: generateRaspberryColors(),
          });
        }

        const customContent = parseCustomColors(customColors);
        if (customContent) {
          sections.push({
            comment: "/* Couleurs personnalisées */",
            content: customContent,
          });
        }

        if (shouldExtrapolate && customColors) {
          const extrapolatedContent = extrapolateCustomColors(customColors);
          if (extrapolatedContent) {
            sections.push({
              comment: "/* Couleurs personnalisées extrapolées */",
              content: extrapolatedContent,
            });
          }
        }

        if (hasFigmaImport && figmaColors && figmaColors.length > 0) {
          const figmaContent = figmaColors
            .map((color) => `  ${color.name}: ${color.value};`)
            .join("\n");

          if (figmaContent) {
            sections.push({
              comment: "/* Couleurs du projet */",
              content: figmaContent,
            });
          }
        }

        return sections;
      }

      function renderSections(containerId, sections) {
        const container = document.getElementById(containerId);

        if (sections.length === 0) {
          container.innerHTML = "<p><em>Aucune section générée</em></p>";
          return;
        }

        sections.forEach((section, index) => {
          const sectionDiv = document.createElement("div");
          sectionDiv.className = "section";

          const commentDiv = document.createElement("div");
          commentDiv.className = "comment";
          commentDiv.textContent = section.comment;
          sectionDiv.appendChild(commentDiv);

          const pre = document.createElement("pre");
          pre.textContent = section.content;
          sectionDiv.appendChild(pre);

          container.appendChild(sectionDiv);
        });
      }

      // Tests
      async function runTests() {
        await loadAllCanonicals();

        // Test 1: Sans import Figma
        const test1 = collectFigmaColors({
          hasFigmaImport: false,
        });
        renderSections("test1", test1);

        // Test 2: Avec couleurs custom
        const test2 = collectFigmaColors({
          hasFigmaImport: false,
          customColors: `--color-brand: oklch(0.55 0.2 250);
--color-accent: oklch(0.65 0.15 150);`,
        });
        renderSections("test2", test2);

        // Test 3: Custom + extrapolation
        const test3 = collectFigmaColors({
          hasFigmaImport: false,
          customColors: `--color-brand: oklch(0.55 0.2 250);`,
          shouldExtrapolate: true,
        });
        renderSections("test3", test3);

        // Test 4: Import Figma (pas de Raspberry)
        const test4 = collectFigmaColors({
          hasFigmaImport: true,
          figmaColors: [
            { name: "--color-primary-500", value: "oklch(0.5 0.2 270)" },
            { name: "--color-secondary-500", value: "oklch(0.6 0.15 180)" },
          ],
        });
        renderSections("test4", test4);

        // Test 5: Figma + custom + extrapolation
        const test5 = collectFigmaColors({
          hasFigmaImport: true,
          customColors: `--color-brand: oklch(0.55 0.2 250);`,
          shouldExtrapolate: true,
          figmaColors: [
            { name: "--color-primary-500", value: "oklch(0.5 0.2 270)" },
          ],
        });
        renderSections("test5", test5);
      }

      runTests();
    </script>
  </body>
</html>
